---
title: "Firestore ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å«ã‚ã‚’ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Firebase, Firestore]
published: true
---

## ã¯ã˜ã‚ã«

Cloud Firestoreã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®Tipsã§ã™ã€‚

## TL;DR

è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤ã—ãŸã ã‘ã ã¨ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ä¸‹è¨˜ã®æ–¹æ³•ã‚’å–ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å†å¸°çš„ã«å‰Šé™¤ã™ã‚‹æ–¹æ³•
2. `firebase-tools`ã‚’ä½¿ç”¨ã—ã¦å‰Šé™¤ã™ã‚‹æ–¹æ³•  
â€»æ•´åˆæ€§ãŒãªã„ãŸã‚ã€éƒ¨åˆ†çš„ãªå‰Šé™¤ãŒç™ºç”Ÿã—ãŸã‚±ãƒ¼ã‚¹ã‚’å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## äº‹å‰æº–å‚™

ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã¨ã—ã¦ã€`comapnies/ABC`ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ãŸã„ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã¦ã„ãã¾ã™ã€‚

å°‘ã—åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€`-`: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³, `+`: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ, `ãƒ»`: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
```
- companies
  + ABC
    ãƒ»owner: éˆ´æœ¨ ä¸€éƒ
    ãƒ»phoneNumber: 13
    - divisions
      + development
        ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
        ãƒ»name: é–‹ç™ºéƒ¨ç½²
        - teams
          + backend
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
          + frontend
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ãƒ•ãƒ­ãƒ³ãƒˆ
          + infra
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ã‚¤ãƒ³ãƒ•ãƒ©
      + sales
        ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
        ãƒ»name: å–¶æ¥­
        - teams
          + corporate
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: é–‹ç™ºéƒ¨ç½²
          + person
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: é–‹ç™ºéƒ¨ç½²
  + DEF
    ....
```

:::details ã“ã¡ã‚‰ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

```ts:index.ts
import * as admin from "firebase-admin";

const serviceAccount = require("./serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

(async () => {
  const db = admin.firestore();

  for (const company of ["ABC", "DEF"]) {
    const companyRef = db.collection("companies").doc(company);
    await companyRef.set({phoneNumber: 123, owner: "éˆ´æœ¨ ä¸€éƒ"});

    const divisionsRef = companyRef.collection("divisions");

    const developmentRef = divisionsRef.doc("development");
    await developmentRef.set({name: "é–‹ç™ºéƒ¨ç½²", leader: "éˆ´æœ¨ ä¸€éƒ"});
    await developmentRef.collection("teams").doc("frontend").set({name: "ãƒ•ãƒ­ãƒ³ãƒˆ", leader: "éˆ´æœ¨ ä¸€éƒ"});
    await developmentRef.collection("teams").doc("backend").set({name: "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰", leader: "éˆ´æœ¨ ä¸€éƒ"});
    await developmentRef.collection("teams").doc("infra").set({name: "ã‚¤ãƒ³ãƒ•ãƒ©", leader: "éˆ´æœ¨ ä¸€éƒ"});

    const salesRef = divisionsRef.doc("sales");
    await salesRef.set({name: "å–¶æ¥­", leader: "éˆ´æœ¨ ä¸€éƒ"});
    await salesRef.collection("teams").doc("corporate").set({name: "é–‹ç™ºéƒ¨ç½²", leader: "éˆ´æœ¨ ä¸€éƒ"});
    await salesRef.collection("teams").doc("person").set({name: "é–‹ç™ºéƒ¨ç½²", leader: "éˆ´æœ¨ ä¸€éƒ"});
  }
})().catch((e) => {
  console.log(e);
});

```

:::


## å†å¸°çš„ã«å‰Šé™¤ã™ã‚‹æ–¹æ³•

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/firestore/manage-data/delete-data?hl=ja#delete_documents)ã«ã‚ã‚‹é€šã‚Šã€FireStoreã¯è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€`await db.collection('companies').doc('ABC').delete();` ã§è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
- companies
  + ABC â†ã€€Filedã¯å‰Šé™¤ã•ã‚Œã‚‹ãŒã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ã•ã‚Œãªã„
    - divisions
      + development
        ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
        ãƒ»name: é–‹ç™ºéƒ¨ç½²
        - teams
          + backend
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
          + frontend
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ãƒ•ãƒ­ãƒ³ãƒˆ
          + infra
            ãƒ»leader: éˆ´æœ¨ ä¸€éƒ
            ãƒ»name: ã‚¤ãƒ³ãƒ•ãƒ©
      ...
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤(Filedã‚‚)ã•ã‚Œã¾ã™ãŒã€ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚
ã¾ãŸã€å®Ÿä½“ãŒãªããªã‚‹ãŸã‚ã€ `db.collection("companies").get()` ã®ã‚ˆã†ã«ã—ã¦ã‚‚ã€`ABC`ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚
[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/firestore/manage-data/delete-data?hl=ja#collections)ã«ã‚‚å®Ÿè£…ä¾‹ãŒã‚ã‚Šã¾ã™ãŒã€ä¸‹è¨˜ã¯ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã‚‚å«ã‚ãŸå®Ÿè£…ä¾‹ã‚’ã¨ãªã‚Šã¾ã™ã€‚

```ts:
import * as admin from "firebase-admin";

const serviceAccount = require("./../../serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const deleteDocumentRecursively = async (docRef: FirebaseFirestore.DocumentReference<FirebaseFirestore.DocumentData>) => {
  const collections = await docRef.listCollections();

  if (collections.length > 0) {
    for (const collection of collections) {
      const snapshot = await collection.get();
      for (const doc of snapshot.docs) {
        await deleteDocumentRecursively(doc.ref);
      }
    }
  }

  await docRef.delete();
};

(async () => {
  const db = admin.firestore();

  // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å«ã‚å†å¸°çš„ã«å‰Šé™¤ã™ã‚‹
  await deleteDocumentRecursively(db.collection("companies").doc("ABC"));
})().catch((e) => {
  console.log(e);
});
```

## firebase-toolsã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•

è‡ªå‰ã§å†å¸°å‡¦ç†ã‚’å®Ÿè£…ã›ãšã€ç°¡å˜ã«å‰Šé™¤ã™ã‚‹æ–¹æ³•ãŒ`firebase-tools`ã‚’ä½¿ã£ãŸã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚
[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/firestore/manage-data/delete-data?hl=ja#collections)ã§ã‚‚ã“ã¡ã‚‰ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
>æœ¬ç•ªç’°å¢ƒã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«æ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã‚’ã”è¦§ãã ã•ã„ã€‚

[è§£æ±ºç­–: å‘¼ã³å‡ºã—å¯èƒ½ãª Cloud Functions ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹](https://firebase.google.com/docs/firestore/solutions/delete-collections?hl=ja#solution_delete_data_with_a_callable_cloud_function) ã«ã‚ã‚‹å®Ÿè£…ä¾‹ã¨ã»ã¼åŒã˜å†…å®¹ã§ã™ã€‚
ãŸã ã€å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€TypeScriptã‚’ä½¿ã†å ´åˆã¯å‹å®šç¾©ã‚’æ›¸ãå¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚

```ts
import * as admin from "firebase-admin";
import {firestore} from "firebase-tools";

const serviceAccount = require("./../../serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

(async () => {
  await firestore.delete("companies/ABC", {
    project: [projectName],
    recursive: true,
    yes: true,
  });
})().catch((e) => {
  console.log(e);
});
```

```ts:firebase-tools.d.ts
declare module "firebase-tools" {
  export namespace firestore {
    function _delete(path: string, options: {project: string, recursive: boolean, yes: boolean, token?: string}): Promise<any>
    export {_delete as delete};
  }
}
```

ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã¯[åˆ¶é™äº‹é …](https://firebase.google.com/docs/firestore/solutions/delete-collections#limitations) ãŒã‚ã‚Šã¾ã™ã€‚

>å‰Šé™¤ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã„ã¤ã‚‚åŒã˜ã‚ˆã†ã«æˆåŠŸã¾ãŸã¯å¤±æ•—ã™ã‚‹ã¨ã„ã†ä¿è¨¼ã‚‚ãªã„ãŸã‚ã€éƒ¨åˆ†çš„ãªå‰Šé™¤ãŒç™ºç”Ÿã—ãŸã‚±ãƒ¼ã‚¹ã‚’å‡¦ç†ã™ã‚‹æº–å‚™ãŒå¿…è¦ã§ã™ã€‚

éƒ¨åˆ†çš„ãªå‰Šé™¤ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã™ã¹ã¦å‰Šé™¤ã•ã‚ŒãŸã‹ã®ç¢ºèªã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ä½¿ç”¨ã™ã‚‹APIãŒã€[runQuery](https://firebase.google.com/docs/firestore/reference/rest/v1/projects.databases.documents/runQuery) ã¨ãªã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…å«ã‚ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚
æ¶ˆã—æ®‹ã—ãŒã‚ã‚‹å ´åˆã¯å†åº¦ã€å‰Šé™¤å‡¦ç†ã‚’è¡Œãˆã°ã€æ•´åˆæ€§ã‚‚æ‹…ä¿å¯èƒ½ã§ã™ã€‚

```ts
import {FirestoreClient} from "@google-cloud/firestore/build/src/v1/firestore_client";
import * as admin from "firebase-admin";

const serviceAccount = require("./../../serviceAccountKey.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

(async () => {
  const client: FirestoreClient = new admin.firestore.v1.FirestoreClient();
  const stream = client.runQuery({
    parent: "projects/firebase-tutorial-suzuki/databases/(default)/documents/companies/ABC",
    structuredQuery: {
      limit: {
        // å–å¾—ä»¶æ•°ã€‚1ä»¶ã®æŒ‡å®šã§è‰¯ã„ã¨æ€ã†
        value: 10,
      },
      from: [
        {allDescendants: true},
      ],
    },
  });

  let count = 0;
  stream.on("data", (response) => {
    if (response.document) {
      count++;
    }
    console.log(response);
  });
  stream.on("end", () => {
    if (count > 0) {
      console.log(`${count}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ®‹ã£ã¦ã‚‹ã‚ˆ`);
    } else {
      console.log("ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å«ã‚æ¶ˆãˆã¦ã„ã‚‹ã‚ˆ");
    }
  });
})().catch((e) => {
  console.log(e);
});

```

### è£œè¶³

`firebase-tools`(v9.3.0æ™‚ç‚¹ã§ã¯) ã®deleteã‚‚åŒã˜ã‚ˆã†ã«ã€`runQuery` ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
https://github.com/firebase/firebase-tools/blob/3c0d4ed89d82117a6081be3b355438a49c01c795/src/firestore/delete.ts#L268

## ãŠã‚ã‚Šã«

Firestoreã§ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã‚’å«ã‚ãŸãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã¯ä»¥å¤–ã¨æ‰‹é–“ãªã‚“ã§ã™ã­...