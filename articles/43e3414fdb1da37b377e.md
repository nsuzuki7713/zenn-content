---
title: "ã€GCPã€‘Secret Manageã‚’è§¦ã£ã¦ã¿ãŸ"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [GCP, SecretManage]
published: true
---

## GCP Secret Managerã¨ã¯
GCPã®Secret Managerã¨ã¯ã€APIã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©å„ç¨®æ©Ÿå¯†æƒ…å ±ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

ä¾‹ãˆã°ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å¤–éƒ¨APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã€APIã‚­ãƒ¼ãŒå¿…è¦ã¨ã—ã¾ã—ã‚‡ã†ã€‚
ã“ã®æ™‚ã€å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ãŒã©ã“ã§ç®¡ç†ã™ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚GitHubã§ç®¡ç†ã™ã‚‹ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è¨­å®šã™ã‚‹ã€‚ãªã©æ§˜ã€…ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—ã€ã“ã®é‹ç”¨ã ã¨æ©Ÿå¯†æƒ…å ±ã¸ã®ç´°ã‹ã„ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ãŒé›£ã—ããªã‚Šã¾ã™ã€‚ã¾ãŸã€APIã‚­ãƒ¼ã‚’æ›´æ–°ã—ãŸéš›ã€ä½¿ç”¨ã—ã¦ã„ã‚‹å…¨ã¦ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã§ã¦ãã¾ã™ã€‚

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã®ãŒGCPã®Secret Managerã§ã™ã€‚
æ©Ÿå¯†æƒ…å ±ã‚’ä¸€å…ƒç®¡ç†ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ©Ÿå¯†æƒ…å ±ã‚’å‚ç…§ã™ã‚‹ã ã‘ã§ã‚ˆããªã‚Šã€ã‚»ã‚­ãƒ¥ã‚¢ã«é‹ç”¨å¯èƒ½ã§ã™ã€‚

ä¸‹è¨˜ã¯Secret Managerã®ã‚¤ãƒ¡ãƒ¼ã‚¸å›³ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c5y1w70t4yfocf83sxjedyuyi2er)

ã–ã£ãã‚Šèª¬æ˜ã™ã‚‹ã¨

- æ©Ÿå¯†æƒ…å ±ã¯Secret Managerã§ä¸€å…ƒç®¡ç†ã™ã‚‹
- æ©Ÿå¯†æƒ…å ±ã¯ç®¡ç†è€…ãŒä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãªã©ã‚’è¡Œã†
- å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯Secret Managerã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å‚ç…§ã™ã‚‹(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§æ©Ÿå¯†æƒ…å ±ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒãªã„)

## æ§‹æˆ

Secret Managerã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a29lf9dap24iv9q0y5b441xr4d5z)

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã„ã†ã¨æ¬¡ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã—ã‚‡ã†ã‹ã€‚

```json
{
  "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿": {
    "ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒªã‚·ãƒ¼": "xxx",
    "ãƒ©ãƒ™ãƒ«": "xxx",
    "æ¨©é™": "xxx"
  },
  "ãƒãƒ¼ã‚¸ãƒ§ãƒ³": [
    {"ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤": "xxx", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": "xxx"},
    {"ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤": "xxx", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": "xxx"}
  ]
}
```

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚
ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚APIã‚­ãƒ¼ã‚„è³‡æ ¼æƒ…å ±ãªã©ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚Œã‚‹å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä½œæˆ

Secret Managerã¯`ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£` > `Secret Manager`ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å€¤ã¯ç›´æ¥å…¥åŠ›ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå¯èƒ½ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/fb0jp0nb6ek30epw87zjkkew8obr)

`gcloud`ã‹ã‚‰ä½œæˆã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚
`echo -n "testpassword2" | gcloud secrets create testpassword2 --data-file=-`

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¿½åŠ 

ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã®æ›´æ–°ã‚’ã—ãŸã„å ´åˆã¯æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ ã‚’è¡Œã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/hzl1jht650a4kynb41dz0jzyjk4s)

`gcloud`ã‹ã‚‰ä½œæˆã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚
`echo -n "add version3" | gcloud secrets versions add testpassword2 --data-file=-`

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å‚ç…§

ã“ã“ã§ã¯gcloudã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
$ gcloud secrets versions access 3 --secret="testpassword2"

# æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹å ´åˆã¯latestã‚’æŒ‡å®š
$ gcloud secrets versions access latest --secret="testpassword2"
```

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¢ºèªã¯å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§SDKã‚’ä½¿ç”¨ã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã¯ã“ã¡ã‚‰ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

https://cloud.google.com/secret-manager/docs/creating-and-accessing-secrets?hl=ja#access

## pubsubã®é€šçŸ¥

ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã®æ©Ÿèƒ½ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¤‰æ›´ã«é–¢ã™ã‚‹æƒ…å ±ã‚’Pub/Subã«é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ ã‚„å‰Šé™¤ã—ãŸéš›ã€slackã«é€šçŸ¥ã‚„ä»»æ„ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

pubsubã®è¨­å®šã¯ç¾åœ¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã¯è¨­å®šã§ãã¾ã›ã‚“ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
$ gcloud beta services identity create --service "secretmanager.googleapis.com"
$ export SM_SERVICE_ACCOUNT="service-...."
# ãƒãƒªã‚·ãƒ¼ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
$ gcloud pubsub topics add-iam-policy-binding topic-test --member "serviceAccount:${SM_SERVICE_ACCOUNT}" --role "roles/pubsub.publisher"
```

topicã®ç´ä»˜ã‘

```bash
# topichèŠ‹ä»˜
$ gcloud beta secrets update testpassword2 --add-topics "projects/${PROJECT_ID}/topics/${TOPIC_NAME}"

# è¨­å®šã®ç¢ºèª
$ gcloud beta secrets describe testpassword2
createTime: '2021-03-28T03:17:28.532523Z'
name: projects/${PROJECT_ID}/secrets/testpassword2
replication:
  automatic: {}
topics:
- name: projects/${PROJECT_ID}/topics/${TOPIC_NAME}
```

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¿½åŠ ã‚’ã™ã‚‹ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé£›ã‚“ã§ã„ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/68zwpc2grvf9o4o3fr6phu7cnwk2)

æ›¸æ–ã‚’çŸ¥ã‚ŠãŸã„å ´åˆã¯ã“ã¡ã‚‰ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://cloud.google.com/secret-manager/docs/event-notifications?hl=ja

## æ–™é‡‘

Secret Managerã¯`ã‚¢ã‚¯ã‚»ã‚¹ ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³	10,000 ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ãŸã‚Š $0.03`ã§èª²é‡‘ã•ã‚Œã¾ã™ã€‚
https://cloud.google.com/secret-manager/pricing?hl=ja

ãã®ãŸã‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã„å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
APIã‚­ãƒ¼ã®å–å¾—ãªã©ã¯åˆå›ã®1åº¦ã ã‘ã§è‰¯ã„ã¨æ€ã†ã®ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œæ™‚ã«1åº¦ã ã‘å–å¾—ã—ã¦ä½¿ã„å›ã™ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦åæ˜ ã™ã‚‹ãªã©ã®å·¥å¤«ã¯å¿…è¦ãã†ã§ã™ã€‚

## ã•ã„ã”ã«

Secret Managerã‚’ä½¿ãˆã°æ©Ÿå¯†æƒ…å ±ã‚’1å…ƒç®¡ç†ã§ããŸã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãªé‹ç”¨ãŒã§ãã¦è‰¯ã•ãã†ã§ã™ã­ã€‚
ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«æœ‰åŠ¹æœŸé™ã‚„pubsubé€šçŸ¥ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆãªã®ã§ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚‚æœŸå¾…ã—ãŸã„ã§ã™ã€‚

## å‚è€ƒ

- https://cloud.google.com/secret-manager?hl=ja
- https://www.apps-gcp.com/sm-with-gcf/
