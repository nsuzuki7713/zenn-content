---
title: "Node.js(TypeScript)ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ“ä½œã™ã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["googlespreadsheet", "nodejs"]
published: true
---

# ã¯ã˜ã‚ã«

Node.js(TypeScript)ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ“ä½œã™ã‚‹æ–¹æ³•ã®ç´¹ä»‹ã§ã™ã€‚

ä»Šå›è©¦ã—ãŸæŒ™å‹•ã¯ä¸‹è¨˜ã§ã™ã€‚

- ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
- æ–°è¦ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
- ã‚·ãƒ¼ãƒˆåã®ä¸€è¦§ã‚’å–å¾—
- 1è¡Œè¿½åŠ ã™ã‚‹
- è¤‡æ•°è¡Œè¿½åŠ ã™ã‚‹
- è¡Œã®ä¸€è¦§ã‚’å–å¾—
- ãƒ˜ãƒƒãƒ€ã‚’å–å¾—
- å‰Šé™¤å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆåã‚’æŒ‡å®šã—ã¦ã€ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤
- å…¨ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤

ã‚³ãƒ¼ãƒ‰ã¯GitHubä¸Šã«ã‚‚ã‚ã‚Šã¾ã™ã€‚
https://github.com/nsuzuki7713/typescript-mono-repo/tree/main/packages/playground/src/spreadsheet

# äº‹å‰æº–å‚™

- [Google Sheets API](https://console.cloud.google.com/apis/api/sheets.googleapis.com/) ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆå´ã«è¨­å®šã™ã‚‹ [ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ](https://console.cloud.google.com/iam-admin/serviceaccounts) ã‚’ä½œæˆã™ã‚‹ã€‚
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®å…±æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã€‚

# ã‚³ãƒ¼ãƒ‰

äº‹å‰æº–å‚™ã§ä½œæˆã—ãŸæƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã¾ã™ã€‚
```env
# ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã«å«ã¾ã‚Œã‚‹æ–‡å­—åˆ—
SHEET_ID='xxxxx'
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹
GOOGLE_SERVICE_ACCOUNT_EMAIL='xxxxx'
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®keyã®JSONã«å«ã¾ã‚Œã‚‹`"private_key"`ã®å€¤
GOOGLE_PRIVATE_KEY='xxxxx'
```

ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ“ä½œã‚’è¡Œã†ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ [google-spreadsheet](https://github.com/theoephraim/node-google-spreadsheet) ã‚’ä½¿ã£ã¦ã¾ã™ã€‚

```typescript
import { GoogleSpreadsheet, GoogleSpreadsheetWorksheet } from 'google-spreadsheet';
import * as dotenv from 'dotenv';

dotenv.config();

/**
 * GoogleSpreadsheet ã‚’æ“ä½œã™ã‚‹ Service
 *
 * @see APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ {@link https://theoephraim.github.io/node-google-spreadsheet/#/}
 */
export class GoogleSpreadsheetService {
  private static instance?: GoogleSpreadsheetService;
  private doc: GoogleSpreadsheet;

  private constructor() {
    this.doc = new GoogleSpreadsheet(process.env.SHEET_ID);
  }

  /**
   * GoogleSpreadsheetService ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã™ã‚‹
   */
  static async getInstance() {
    if (this.instance) {
      return this.instance;
    }

    const instance = new GoogleSpreadsheetService();

    await instance.doc.useServiceAccountAuth({
      client_email: process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL ?? '',
      private_key: (process.env.GOOGLE_PRIVATE_KEY ?? '').replace(/\\n/g, '\n'),
    });
    await instance.doc.loadInfo();

    return instance;
  }

  /**
   * ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹
   *
   * @returns ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«
   */
  getTitle() {
    return this.doc.title;
  }

  /**
   * ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´ã™ã‚‹
   *
   * @param title å¤‰æ›´å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«å
   */
  async getRenameTitle(title: string) {
    await this.doc.updateProperties({ title });
  }

  /**
   * æ–°è¦ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹
   *
   * @param sheetName ã‚·ãƒ¼ãƒˆå
   * @param headerValues ãƒ˜ãƒƒãƒ€ã®å€¤
   * @returns è¿½åŠ ã—ãŸã‚·ãƒ¼ãƒˆ
   */
  async addSheet(sheetName: string, headerValues?: string[]): Promise<GoogleSpreadsheetWorksheet> {
    return await this.doc.addSheet({ title: sheetName, headerValues });
  }

  /**
   * å¼•æ•°ã§æ¸¡ã—ãŸã‚·ãƒ¼ãƒˆåã‚’å‰Šé™¤ã™ã‚‹ã€‚
   *
   * @param sheetTitle å‰Šé™¤å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆå
   */
  async deleteSheetByTitle(sheetTitle: string) {
    const sheet = this.doc.sheetsByTitle[sheetTitle];

    if (!sheet) {
      return;
    }
    await sheet.delete();
  }

  /**
   * å…¨ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã€‚
   */
  async deleteAllSheet() {
    const sheets = this.doc.sheetsByIndex;

    Promise.all(sheets.map((s) => s.delete()));
  }

  /**
   * sheetåã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã€‚
   */
  async sheetNames(): Promise<string[]> {
    return this.doc.sheetsByIndex.map((sheet) => sheet.title);
  }

  /**
   * è¡Œã‚’è¿½åŠ ã™ã‚‹
   *
   * @param sheetTitle ã‚·ãƒ¼ãƒˆå
   * @param values è¿½åŠ ã™ã‚‹è¡Œã®å€¤
   */
  async addRow(sheetTitle: string, values: string[] | Record<string, string | number | boolean>) {
    const sheet = this.doc.sheetsByTitle[sheetTitle];

    if (!sheet) {
      return;
    }
    await sheet.addRow(values);
  }

  /**
   * è¤‡æ•°è¡Œã‚’è¿½åŠ ã™ã‚‹
   *
   * @param sheetTitle ã‚·ãƒ¼ãƒˆå
   * @param values è¿½åŠ ã™ã‚‹è¡Œã®å€¤ã®é…åˆ—
   */
  async addRows(sheetTitle: string, values: (string[] | Record<string, string | number | boolean>)[]) {
    const sheet = this.doc.sheetsByTitle[sheetTitle];

    if (!sheet) {
      return;
    }
    await sheet.addRows(values);
  }

  /**
   * è¡Œã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã€‚
   *
   * @param sheetTitle ã‚·ãƒ¼ãƒˆå
   * @param header é …ç›®ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹
   */
  async getRows(sheetTitle: string, header: string[]) {
    const sheet = this.doc.sheetsByTitle[sheetTitle];

    if (!sheet) {
      return [];
    }
    const rows = await sheet.getRows();

    return rows.map((row) => header.map((h) => row[h]));
  }

  /**
   * ãƒ˜ãƒƒãŒè¡Œã‚’å–å¾—ã™ã‚‹ã€‚
   *
   * @param sheetTitle ã‚·ãƒ¼ãƒˆå
   * @returns ãƒ˜ãƒƒãƒ€ã®å€¤ã®é…åˆ—
   */
  getHeader(sheetTitle: string) {
    const sheet = this.doc.sheetsByTitle[sheetTitle];

    if (!sheet) {
      return [];
    }
    return sheet.headerValues;
  }
}
```

ä½¿ã‚ã‚Œæ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

```typescript
const spreadService = await GoogleSpreadsheetService.getInstance();

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
console.log(spreadService.getTitle());

// ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
await spreadService.getRenameTitle('rename title');

// æ–°è¦ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
await spreadService.addSheet('newSheet1');
await spreadService.addSheet('newSheet2', ['name', 'email']); // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚ä¸€ç·’ã«è¨­å®š

// ã‚·ãƒ¼ãƒˆåã®ä¸€è¦§ã‚’å–å¾—
console.log(await spreadService.sheetNames());

// 1è¡Œè¿½åŠ ã™ã‚‹
await spreadService.addRow('newSheet1', ['aaa', 'bbb', 'ddd']);
await spreadService.addRow('newSheet2', {name: 'suzuki', email: 'aaa'}); // ãƒ˜ãƒƒãƒ€ä¼¼åˆã†ã‚ˆã†ãªå½¢ã§è¡Œã‚’è¿½åŠ 

// è¤‡æ•°è¡Œè¿½åŠ ã™ã‚‹
await spreadService.addRow('newSheet1', [['aaa', 'bbb', 'ddd'], ['eee', 'fff]]);
await spreadService.addRow('newSheet2', {name: 'suzuki', email: 'aaa'}, {name: 'sato', email: 'bbb'} ); // ãƒ˜ãƒƒãƒ€ä¼¼åˆã†ã‚ˆã†ãªå½¢ã§è¡Œã‚’è¿½åŠ 

// è¡Œã®ä¸€è¦§ã‚’å–å¾—
console.log(await spreadService.getRows('newSheet2', ['name', 'email']));

// ãƒ˜ãƒƒãƒ€ã‚’å–å¾—
console.log(await spreadService.getHeader('newSheet2'));

// å‰Šé™¤å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆåã‚’æŒ‡å®šã—ã¦ã€ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤
await spreadService.deleteSheetByTitle('newSheet1');

// å…¨ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤
await spreadService.deleteAllSheet();
```

# å‚è€ƒ

https://zenn.dev/catnose99/scraps/2d0abd8f32f91e