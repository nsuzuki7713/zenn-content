---
title: "Cloud Pub/Subã‚’è§¦ã£ã¦ã¿ãŸ"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [GCP, PubSub]
published: true
---


## ã¯ã˜ã‚ã«

GCPã®PubSubã‚’è§¦ã£ã¦ã¿ãŸã®ã§ãã‚Œã®å‚™å¿˜éŒ²ã§ã™ã€‚

PubSubã®æ¦‚è¦ã§ã™ãŒã€GCPSketchnoteã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¨ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãå›³ã«çºã‚ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚
ï¼ˆä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ã™ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/xrvmtt12ldoowcdhfjcwjjx5n3r2)
https://github.com/priyankavergadia/GCPSketchnote

ã–ã£ã¨ã—ãŸæµã‚Œã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ãŒãƒˆãƒ”ãƒƒã‚¯ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
2. ãƒˆãƒ”ãƒƒã‚¯ã¯å±Šã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã«é…ä¿¡
3. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯å±Šã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç®¡ç†ã—ã€ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    - pushå‹ã®å ´åˆã¯ã€æŒ‡å®šã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    - pullå‹ã®å ´åˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹

ä»Šå›ã¯ä¸‹è¨˜ã®æ§‹æˆã§PubSubã®å‹•ãã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/pgbyw7j9zu6ew0t92pl6u0usgcs7)

## æ§‹ç¯‰

### TOPICã®ä½œæˆ

æœ€åˆã«â‘¡ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯gcloudã§ä½œæˆã—ã¾ã™ã€‚

`gcloud pubsub topics create topic-test`

https://cloud.google.com/sdk/gcloud/reference/pubsub/topics/create?hl=ja

### cloudfunctionã®ä½œæˆã¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä½œæˆ

æ¬¡ã«â‘¢ã¨â‘¤ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã—ã¾ã—ãŸãŒã€cloudfunctionã®pubsubãƒˆãƒªã‚¬ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚‚åŒæ™‚ã«ä½œæˆã•ã‚Œã¾ã™ã€‚


![](https://storage.googleapis.com/zenn-user-upload/w8m0pmo8yg0kikulvkcsywn8un0k)

![](https://storage.googleapis.com/zenn-user-upload/5pyx82qbnng62bshhrk2zpwht3m5)

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹é€šã‚Špubsubã§ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸéš›ã€ackã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯æ˜ç¤ºçš„ã«ackã—ã¾ã™ãŒã€cloudfunctionã§ã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã›ãšçµ‚äº†ã™ã‚‹ã“ã¨ã§ackã—ã¾ã™ã€‚

>æ³¨: ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã€è‡ªå‹•å†è©¦è¡ŒãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å ´åˆã€é–¢æ•°ã®å‘¼ã³å‡ºã—æ™‚ã€Cloud Functions ã¯å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å†…éƒ¨ã§ ack ã—ã¾ã™ã€‚ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚ŒãŸã¨ãã«å‘¼ã³å‡ºã—ã‚’è‡ªå‹•çš„ã«å†è©¦è¡Œã™ã‚‹æ–¹æ³•ã®è©³ç´°ã¯ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é–¢æ•°ã®å†è©¦è¡Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚
https://cloud.google.com/functions/docs/calling/pubsub?hl=ja

### ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä½œæˆ

â‘£ã®pushå‹ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

`gcloud pubsub subscriptions create subscription-pull-test --topic=topic-test`

https://cloud.google.com/sdk/gcloud/reference/pubsub/subscriptions/create?hl=ja

### ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä¸€è¦§ã®ç¢ºèª

ä½œæˆã—ãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯`list`ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

`gcloud pubsub subscriptions list`

```bash
$ gcloud pubsub subscriptions list
---
ackDeadlineSeconds: 600
expirationPolicy: {}
messageRetentionDuration: 604800s
name: projects/${PROJECT}/subscriptions/gcf-subscribePushFunction-asia-northeast1-topic-test
pushConfig:
  attributes:
    x-goog-version: v1
  pushEndpoint: https://xxxxx.appspot.com/_ah/push-handlers/pubsub/projects/${PROJECT}/topics/topic-test?pubsub_trigger=true
topic: projects/${PROJECT}/topics/topic-test
---
ackDeadlineSeconds: 10
expirationPolicy:
  ttl: 2678400s
messageRetentionDuration: 604800s
name: projects/${PROJECT}/subscriptions/subscription-pull-test
pushConfig: {}
topic: projects/firebase-tutorial-suzuki/topics/topic-test
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚’ä½œæˆ

â‘¥ã®ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts:subscribePullFunctions.ts
import { PubSub } from '@google-cloud/pubsub';

const pubSubClient = new PubSub({ projectId: '${PROJECT}', keyFilename: './key.json' });
const subscriptionName = 'subscription-pull-test';
const timeout = 300;

function listenForMessages() {
  const subscription = pubSubClient.subscription(subscriptionName);

  let messageCount = 0;
  const messageHandler = (message: any) => {
    console.log(`Received message :`, message.id);
    console.log(`Data: `, message.data.toString());
    console.log(`Attributes:`, message.attributes);
    messageCount += 1;

    message.ack();
  };

  subscription.on('message', messageHandler);

  setTimeout(() => {
    subscription.removeListener('message', messageHandler);
    console.log(`${messageCount} message(s) received.`);
  }, timeout * 1000);
}

// 5åˆ†é–“pubsubã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹
listenForMessages();
```

å®Ÿè£…ã¯ã“ã¡ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ã—ã¾ã—ãŸã€‚
https://cloud.google.com/pubsub/docs/pull

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã‚’ä½œæˆ

```ts:publish.ts
import { PubSub } from '@google-cloud/pubsub';

const pubSubClient = new PubSub({ projectId: '${PROJECT}', keyFilename: './key.json' });
const topicName = 'topic-test';

async function publishMessageWithCustomAttributes() {
  for (let i = 0; i < 10; i++) {
    const dataBuffer = Buffer.from(JSON.stringify({ data: `message${i}` }));

    const customAttributes = {
      origin: 'nodejs-sample',
      username: 'gcp',
    };

    const messageId = await pubSubClient.topic(topicName).publish(dataBuffer, customAttributes);
    console.log(`Message ${messageId} published.`);
  }
}

publishMessageWithCustomAttributes().catch(console.error);
```

å®Ÿè£…ã¯ã“ã¡ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ã—ã¾ã—ãŸã€‚
https://cloud.google.com/pubsub/docs/publisher

## å®Ÿè¡Œãƒ­ã‚°ç¢ºèª

ä½œæˆã—ãŸ`subscribePullFunctions.ts`ã‚’èµ·å‹•ã—ã€`publish.ts`ã‚’å®Ÿè¡Œã—ãŸçµæœã§ã™ã€‚

publish.tsã®ãƒ­ã‚°
```
Message 2112903639819498 published.
Message 2112906498485253 published.
Message 2112905325376611 published.
Message 2112906488308818 published.
Message 2112906413743836 published.
Message 2112906048095929 published.
Message 2112905458525780 published.
Message 2112904243928711 published.
Message 2112904943349963 published.
Message 2112905305575893 published.
```

`subscribePullFunctions.ts`
```
Received message : 2112903639819498
Data:  {"data":"message0"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112906498485253
Data:  {"data":"message1"}
Attributes: { username: 'gcp', origin: 'nodejs-sample' }
Received message : 2112905325376611
Data:  {"data":"message2"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112906488308818
Data:  {"data":"message3"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112906413743836
Data:  {"data":"message4"}
Attributes: { username: 'gcp', origin: 'nodejs-sample' }
Received message : 2112906048095929
Data:  {"data":"message5"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112905458525780
Data:  {"data":"message6"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112904243928711
Data:  {"data":"message7"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
Received message : 2112904943349963
Data:  {"data":"message8"}
Attributes: { username: 'gcp', origin: 'nodejs-sample' }
Received message : 2112905305575893
Data:  {"data":"message9"}
Attributes: { origin: 'nodejs-sample', username: 'gcp' }
```

cloudfunctionã®ãƒ­ã‚°
![](https://storage.googleapis.com/zenn-user-upload/nf6p8m1bl2bolbjv7441mbf4c7rr)

Cloudfunctionãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨é€ä¿¡é †ã«ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚PubSubã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é †ç•ªãƒãƒ©ãƒãƒ©ã«ãªã‚‹ã®ã§ã€ä¸¦ã¹ãŸã„å ´åˆã¯é †åºæŒ‡å®šã‚­ãƒ¼ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
https://cloud.google.com/pubsub/docs/publisher#using_ordering_keys

## ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

ç¾åœ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã®æ©Ÿèƒ½ã§ã™ãŒã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã¯ã©ã‚“ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚‚é€ä¿¡å¯èƒ½ã§ã™ãŒã€æ™‚ã«ã¯ç‰¹å®šã®æ§‹é€ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã†ã„ã†æ™‚ã«ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹éš›ã«å®šç¾©ã«åˆã‚ãªã„ã‚‚ã®ã‚’å¼¾ãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

https://cloud.google.com/pubsub/docs/schemas#gcloud

### ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ

ä»Šå›ã¯ä¸‹è¨˜ã®æ§‹é€ ã‚’ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚
```
{
  StringField: string,
  FloatField: float,
  BooleanField: boolean
}
```

ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆã®ãŸã‚ã€gccloudã¯betaç‰ˆã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚

```
gcloud beta pubsub schemas create testSchema \
--type=AVRO \
--definition="{\"type\":\"record\",\"name\":\"Avro\",\"fields\":[{\"name\":\"StringField\",\"type\":\"string\"},{\"name\":\"FloatField\",\"type\":\"float\"},{\"name\":\"BooleanField\",\"type\":\"boolean\"}]}"
```

### topicã®ä½œæˆ

ã‚¹ã‚­ãƒ¼ãƒã¯ç¾åœ¨ã€ãƒˆãƒ”ãƒƒã‚¯ä½œæˆæ™‚ã®ã¿ã«ä»˜ä¸ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ãƒˆãƒ”ãƒƒã‚¯ã®æ›´æ–°ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å¤–ã—ãŸã‚Šã™ã‚‹ã“ã¨ã¯ã§ããªã„ã‚ˆã†ã§ã™ã€‚ã¾ãŸã€ã‚¹ã‚­ãƒ¼ãƒã‚’å‰Šé™¤ã™ã‚‹ã¨ç´ä»˜ã„ãŸãƒˆãƒ”ãƒƒã‚¯ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã¹ã¦å¤±æ•—ã™ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

```
gcloud beta pubsub topics create avrotopic \
--message-encoding=JSON \
--schema=testSchema
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡

æ§‹é€ ãŒæ­£ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
```bash
$ gcloud pubsub topics publish avrotopic \
--message="{\"StringField\":\"test\",\"FloatField\":123,\"BooleanField\":false}"

messageIds:
- '2113507840724102'
```

æ§‹é€ ãŒæ­£ã—ããªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
```
gcloud pubsub topics publish avrotopic \
--message="{\"StringField\":\"test\"}"

ERROR: (gcloud.pubsub.topics.publish) INVALID_ARGUMENT: Request contains an invalid argument.
```

## çµ‚ã‚ã‚Šã«

ä»Šå›ã€Pub/Subã‚’ä¸€é€šã‚Šè§¦ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡æ™‚ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã§ãã‚‹ã‚¹ã‚­ãƒ¼ãƒã¯ä¾¿åˆ©ã§ã™ãŒã€ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã¨ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã§å…±æœ‰ã™ã‚‹æ–¹æ³•ã€TOPICã«ç´ã¥ãã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ãªã©è€ƒãˆã‚‹ã“ã¨ãŒçµæ§‹ã‚ã‚Šãã†ã§ã—ãŸã€‚ã¾ã ãƒ™ãƒ¼ã‚¿ç‰ˆãªã®ã§ã“ã®è¾ºãŒæ”¹å–„ã•ã‚Œã‚Œã°ä½¿ãˆãã†ãªæ°—ãŒã—ã¾ã™ã€‚

ã¾ãŸã€GCPã«ã¯Pub/Subã¨ä¼¼ãŸã‚µãƒ¼ãƒ“ã‚¹ã®Cloud TaskãŒã‚ã‚Šã¾ã™ã€‚æ¯”è¼ƒã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://cloud.google.com/tasks/docs/comp-pub-sub?hl=ja

## å‚è€ƒè³‡æ–™

https://future-architect.github.io/articles/20210309/